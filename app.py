from flask import Flask, render_template, request, jsonify

app = Flask(__name__, template_folder='.')

salary_table = {
    ("ассистент", "нет", "нет"): 31150,
    ("ассистент", "кандидат наук", "нет"): 35080,
    ("ассистент", "доктор наук", "нет"): 35080,
    ("старший преподаватель", "нет", "нет"): 34440,
    ("старший преподаватель", "кандидат наук", "нет"): 38360,
    ("старший преподаватель", "доктор наук", "нет"): 38360,
    ("доцент", "нет", "нет"): 39820,
    ("доцент", "нет", "доцент"): 39820,
    ("доцент", "нет", "профессор"): 39820,
    ("доцент", "кандидат наук", "нет"): 41850,
    ("доцент", "кандидат наук", "доцент"): 43880,
    ("доцент", "кандидат наук", "профессор"): 43880,
    ("доцент", "доктор наук", "нет"): 49840,
    ("доцент", "доктор наук", "доцент"): 49840,
    ("доцент", "доктор наук", "профессор"): 49840,
    ("профессор", "нет", "нет"): 46590,
    ("профессор", "нет", "профессор"): 46590,
    ("профессор", "нет", "доцент"): 46590,
    ("профессор", "кандидат наук", "нет"): 50780,
    ("профессор", "кандидат наук", "профессор"): 50780,
    ("профессор", "кандидат наук", "доцент"): 50780,
    ("профессор", "доктор наук", "нет"): 57880,
    ("профессор", "доктор наук", "профессор"): 60820,
    ("профессор", "доктор наук", "доцент"): 57880,
    ("зав. кафедрой", "нет", "нет"): 50360,
    ("зав. кафедрой", "нет", "профессор"): 51370,
    ("зав. кафедрой", "нет", "доцент"): 50360,
    ("зав. кафедрой", "кандидат наук", "нет"): 50360,
    ("зав. кафедрой", "кандидат наук", "профессор"): 51370,
    ("зав. кафедрой", "кандидат наук", "доцент"): 50360,
    ("зав. кафедрой", "доктор наук", "нет"): 63460,
    ("зав. кафедрой", "доктор наук", "профессор"): 66480,
    ("зав. кафедрой", "доктор наук", "доцент"): 63460,
}

assist_ranges_by_rate = {
    0.1: [(0, 90), (91, 180), (181, 270), (271, 360), (361, 450), (451, 540), (541, 630), (631, 720), (721, 810), (811, 900), (901, 990), (991, 1080), (1081, 1170), (1171, 1260), (1261, 1350)],
    0.25: [(0, 225), (226, 270), (271, 360), (361, 450), (451, 540), (541, 630), (631, 720), (721, 810), (811, 900), (901, 990), (991, 1080), (1081, 1170), (1171, 1260), (1261, 1350)],
    0.5: [(0, 450), (451, 540), (541, 630), (631, 720), (721, 810), (811, 900), (901, 990), (991, 1080), (1081, 1170), (1171, 1260), (1261, 1350)],
    0.75: [(0, 675), (676, 720), (721, 810), (811, 900), (901, 990), (991, 1080), (1081, 1170), (1171, 1260), (1261, 1350)],
    1.0: [(0, 900), (901, 990), (991, 1080), (1081, 1170), (1171, 1260), (1261, 1350)],
}

other_ranges_by_rate = {
    0.1: [(0, 81), (82, 162), (163, 243), (244, 324), (325, 405), (406, 486), (487, 567), (568, 648), (649, 729), (730, 810), (811, 891), (892, 972), (973, 1053), (1054, 1134), (1135, 1215)],
    0.25: [(0, 81), (82, 162), (163, 243), (244, 324), (325, 405), (406, 486), (487, 567), (568, 648), (649, 729), (730, 810), (811, 891), (892, 972), (973, 1053), (1054, 1134), (1135, 1215)],
    0.5: [(0, 81), (82, 162), (163, 243), (244, 324), (325, 405), (406, 486), (487, 567), (568, 648), (649, 729), (730, 810), (811, 891), (892, 972), (973, 1053), (1054, 1134), (1135, 1215)],
    0.75: [(0, 81), (82, 162), (163, 243), (244, 324), (325, 405), (406, 486), (487, 567), (568, 648), (649, 729), (730, 810), (811, 891), (892, 972), (973, 1053), (1054, 1134), (1135, 1215)],
    1.0: [(0, 81), (82, 162), (163, 243), (244, 324), (325, 405), (406, 486), (487, 567), (568, 648), (649, 729), (730, 810), (811, 891), (892, 972), (973, 1053), (1054, 1134), (1135, 1215)],
}

assist_coeffs_by_rate = {1.0: [0, 1, 2, 3, 4, 5], 0.75: [0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5], 0.5: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], 0.25: [0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 12.5], 0.1: list(range(15))}
other_coeffs_by_rate = {1.0: [0, 1, 2, 3, 4, 5], 0.75: [0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5], 0.5: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], 0.25: [0, 0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 12.5], 0.1: list(range(15))}

def get_category(position: str) -> str:
    if "ассистент" in position.lower() or "старший" in position.lower():
        return "assist"
    return "other"

def get_coefficient(rate: float, load_hours: int, position: str) -> float:
    category = get_category(position)
    if category == "assist":
        ranges = assist_ranges_by_rate.get(rate, assist_ranges_by_rate[0.1])
        coeffs = assist_coeffs_by_rate.get(rate, assist_coeffs_by_rate[0.1])
    else:
        ranges = other_ranges_by_rate.get(rate, other_ranges_by_rate[0.1])
        coeffs = other_coeffs_by_rate.get(rate, other_coeffs_by_rate[0.1])
    
    for idx, (start, end) in enumerate(ranges):
        if start <= load_hours <= end:
            return coeffs[idx] if idx < len(coeffs) else coeffs[-1]
    return coeffs[-1] if coeffs else 0

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/calculate', methods=['POST'])
def calculate():
    data = request.json
    position = data.get('position')
    degree = data.get('degree')
    rank = data.get('rank')
    rate = float(data.get('rate', 1.0))
    load_hours = int(data.get('load_hours', 0))
    
    pos_key = "ассистент" if "Ассистент" in position else \
              "старший преподаватель" if "Старший" in position else \
              "доцент" if "Доцент" in position else \
              "профессор" if "Профессор" in position else \
              "зав. кафедрой"
    
    degree_key = "нет" if "Нет" in degree else \
                 "кандидат наук" if "Кандидат" in degree else \
                 "доктор наук"
    
    rank_key = "нет" if "Нет" in rank else \
               "профессор" if "Профессор" in rank else \
               "доцент"
    
    salary_key = (pos_key, degree_key, rank_key)
    base_salary_1 = salary_table.get(salary_key, 31150)
    
    oklad = base_salary_1 * rate
    coef = get_coefficient(rate, load_hours, position)
    base_supplement = base_salary_1 * 0.1
    doplata = base_supplement * coef
    rk_sn = 0.5 * (oklad + doplata)
    itog = oklad + doplata + rk_sn
    
    return jsonify({
        'oklad': round(oklad, 2),
        'doplata': round(doplata, 2),
        'rk_sn': round(rk_sn, 2),
        'total': round(itog, 2)
    })

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
